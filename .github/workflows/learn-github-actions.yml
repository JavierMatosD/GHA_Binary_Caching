name: learn-github-actions
run-name: Testing Binary Caching with Github Actions
on: [push]
jobs:
  build_linux_static:
    name: x64-linux
    runs-on: ubuntu-latest
    steps:
      - name: Check Version
        uses: actions/checkout@v3
        with:
          submodules: true
      - run: ./vcpkg-exe --version
      - name: Clear Cache
        run: |
          gh extension install actions/gh-actions-cache

          REPO=${{ github.repository }}
          BRANCH="main"

          echo "Fetching list of cache key"
          cacheKeysForPR=$(gh actions-cache list -R $REPO -B $BRANCH | cut -f 1 )

          ## Don't fail workflow
          echo "Deleting caches..."
          do
            gh actions-cache delete $cacheKey -R $REPO -B $BRANCH --confirm
            echo "deleted $cacheKey"
          done
          echo "done
      - name: Export Required Environment Variables
        uses: actions/github-script@v6
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
      - run: cp ./vcpkg-exe vcpkg/vcpkg
      - name: Install Boost
        run: |
          ./vcpkg/vcpkg install boost --binarysource="clear;x-gha,readwrite"